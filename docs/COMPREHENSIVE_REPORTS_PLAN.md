# خطة صفحة التقارير الشاملة — تقرير واحد يغطي كل النظام

> **تطوير الواجهة والرسوميات:** انظر **`REPORTS_UI_ENHANCEMENT_PLAN.md`** لخطة واجهة مثالية مع رسوميات وصور واعتماد على **جدول تفاصيل التسويات فقط** (بدون rtgs).

## الهدف

صفحة تقارير **عملاقة وشاملة** تمنح مديراً مفوّضاً:
- **نظرة عامة** عن عمل القسم وإنجازاته (مهام، حضور، تسويات، مطابقات، فئات، تجار).
- **تفصيل كل موظف** (حضور، مهام منجزة، في الوقت، متأخرة، تغطية، توزيع الفئات).
- **كل ما في النظام** دون استثناء: مهام مجدولة وإضافية، تسويات حكومية، RTGS، مطابقة CT، صرف مستحقات التجار، الفئات، الحضور، سجل التدقيق.

---

## مرجعية الجداول (22 جدولاً)

| الجدول | الحجم التقريبي | الاستخدام في التقرير |
|--------|----------------|------------------------|
| **users** | 104K | قائمة الموظفين، أسماء، أدوار |
| **attendance** | 320K | أيام الحضور، أول دخول، إحصائيات حضور |
| **daily_tasks** | 224K | مهام مجدولة، حالة، تعيين، تاريخ الاستحقاق |
| **ad_hoc_tasks** | 64K | مهام إضافية، تعيين، حالة |
| **task_executions** | 144K | تنفيذ المهام، منفذ، في الوقت/متأخر، مدة |
| **task_templates** | 64K | عناوين المهام، ربط بالفئة |
| **categories** | 64K | أسماء الفئات، توزيع المهام |
| **schedules** | 80K | الجداول (خلفية للمهام المجدولة) |
| **attachments** | 16K | مرفقات تنفيذ المهام (عدد/مرجع) |
| **import_logs** | 128K | قائمة ملفات الاستيراد (سياق فقط — لا يُستخرج منها أرقام حركات أو مبالغ) |
| **gov_settlement_summaries** | 120K | **مصدر أرقام التسويات:** إحصائيات حسب تاريخ/مصرف (حركات، مبالغ، تسوية) |
| **gov_settlement_details** | 1.4M | **تفاصيل التسوية:** إحصاءات/توزيع حسب مصرف، وزارة، مديرية، محافظة |
| **settlement_maps** | 64K | أسماء المصارف — للعرض في ملخصات التسوية |
| *(لا يُستخدم rtgs في التقارير)* | — | الاعتماد بالكامل على جداول التفاصيل والملخصات أعلاه |
| **ct_records** | 64K | سجلات CT — مطابقة/غير مطابقة، قيم، تواريخ |
| **merchants** | 816K | عدد التجار، خيارات (للربط مع المستحقات) |
| **merchant_disbursements** | 80K | صرف مستحقات التجار — عدد حوالات، إجمالي مبالغ في الفترة |
| **audit_log** | 328K | سجل التدقيق — آخر أحداث (اختياري) |
| **user_permissions** | 120K | صلاحيات (خلفية، لا يُعرض تفصيلاً في التقرير) |
| **permission_definitions** | 48K | تعريفات الصلاحيات (خلفية) |
| **settings** | 48K | إعدادات (خلفية) |
| **migrations** | 40K | لا يُستخدم في التقرير |

---

## هيكل التقرير الشامل (أقسام الصفحة)

### المستوى 0: فلتر الفترة وشريط الملخص العام (أعلى الصفحة)

- **الفترة:** يوم واحد | أسبوع | شهر | نطاق مخصص (من تاريخ – إلى تاريخ).
- **شريط KPI عامة (أرقام سريعة):**
  - عدد الموظفين النشطين، من حاضروا في الفترة، إجمالي أيام الحضور.
  - إجمالي المهام (مجدولة + إضافية)، مكتملة، في الوقت، متأخرة، معلقة، نسبة الإنجاز.
  - استيرادات RTGS (عدد)، حركات RTGS (عدد)، إجمالي مبالغ/تسوية (إن وُجد).
  - سجلات CT (عدد)، مطابقة / غير مطابقة.
  - مهام التسوية الحكومية (عدد)، صرف مستحقات التجار (عدد حوالات / إجمالي مبلغ).

---

### القسم 1: القسم والموظفون (نظرة عامة)

- **مصدر البيانات:** `users`, `attendance`, `task_executions`, `daily_tasks`, `ad_hoc_tasks`, `categories`, `task_templates`.
- **المحتوى:**
  - إحصائيات القسم المجمّعة للفترة: إجمالي مهام، منجزة، في الوقت، متأخرة، أيام حضور، نسبة الدقة (في الوقت / إجمالي).
  - توزيع المهام حسب **الفئة** (من `categories` + تنفيذات): كل فئة → عدد مهام، منجزة، متأخرة، معلقة.
  - جدول/قائمة **موظفين** (موظفين فقط): اسم، أيام حضور، مهام منجزة، في الوقت، متأخرة، تغطية، نسبة الدقة — مع إمكانية النقر للانتقال لتفصيل الموظف.

---

### القسم 2: تفصيل كل موظف

- **مصدر البيانات:** نفس الجداول أعلاه + `attendance` مفصل حسب `user_id`.
- **المحتوى (لكل موظف، قابلة للطي/توسيع):**
  - **حضور:** أيام الحضور في الفترة، أول دخول (مثلاً أول وآخر تاريخ في الفترة).
  - **مهام مجدولة:** إجمالي، مكتملة، في الوقت، متأخرة، معلقة.
  - **مهام إضافية:** إجمالي، مكتملة.
  - **تغطية:** عدد المهام التي نفذها نيابة عن غيره.
  - **توزيع حسب الفئة:** لكل فئة عدد المهام المنفذة.
  - **أفضل يوم:** اليوم الذي أنجز فيه أكبر عدد مهام (من TV).
  - **متوسط مدة التنفيذ** (إن وُجد في `task_executions.duration_minutes`).

---

### القسم 3: المهام والتنفيذ

- **مصدر البيانات:** `daily_tasks`, `ad_hoc_tasks`, `task_executions`, `task_templates`, `users`, `categories`.
- **المحتوى:**
  - **ملخص المهام المجدولة:** حسب التاريخ (أو الشهر): عدد، مكتملة، متأخرة، معلقة.
  - **ملخص المهام الإضافية:** عدد في الفترة، مكتملة.
  - **قائمة المهام المتأخرة** (في الفترة): مهمة، مسندة إلى، منفذ، تاريخ الاستحقاق، حالة.
  - **تقرير التغطية:** من نفذ مهام غيره (مصفوفة أو جدول: منفذ ← مسند إليه ← عدد).

---

### القسم 4: التسويات (بدون جدول rtgs — تفاصيل وملخصات فقط)

- **مصدر البيانات:** `gov_settlement_summaries`, `gov_settlement_details`, `import_logs` (قائمة استيراد للسياق فقط).
- **المحتوى:**
  - **إحصائيات التسويات للفترة:** من `gov_settlement_summaries`: عدد الحركات، إجمالي المبلغ، العمولات، إجمالي التسوية (sttle).
  - **ملخص التسويات:** حسب تاريخ التسوية و/أو المصرف (من `gov_settlement_summaries`).
  - **تفاصيل حسب المصرف/الجهة:** من `gov_settlement_details`: توزيع حسب مصرف، وزارة، مديرية، أو محافظة (إحصاءات مجمّعة دون تحميل صفوف خام كثيرة).
  - **قائمة ملفات الاستيراد (اختياري):** من `import_logs` للسياق فقط.
  - **لا يُستخدم جدول rtgs** في أي استعلام.

---

### القسم 5: مطابقة CT

- **مصدر البيانات:** `ct_records`, `users`.
- **المحتوى:**
  - عدد السجلات في الفترة (حسب `sttl_date_from`/`sttl_date_to` أو `ct_received_date`).
  - مطابقة / غير مطابقة (عدد وقيم إن وُجدت).
  - جدول مختصر: تاريخ من–إلى، قيمة CT، sum_acq، sum_fees، حالة المطابقة، مستخدم الإدخال (من `users`).

---

### القسم 6: التجار وصرف المستحقات

- **مصدر البيانات:** `merchants`, `merchant_disbursements`, `users`.
- **المحتوى:**
  - عدد التجار (من `merchants`).
  - في الفترة: عدد حوالات صرف مستحقات، إجمالي المبلغ المُصرف، (اختياري) تفصيل حسب تاجر أو حسب شهر.

---

### القسم 7: الفئات

- **مصدر البيانات:** `categories`, `task_templates`, `daily_tasks`, `ad_hoc_tasks`, `task_executions`.
- **المحتوى:**
  - لكل فئة: عدد المهام (مجدولة + إضافية) في الفترة، مكتملة، متأخرة، معلقة.
  - يمكن عرض نفس المنطق المستخدم في TV (شريحة الفئات + إنجازات الشهر حسب الفئة).

---

### القسم 8: مهام التسوية الحكومية (مهام ذات target_settlement_date)

- **مصدر البيانات:** `daily_tasks`, `task_executions`, `task_templates`, `users`.
- **المحتوى:**
  - عدد المهام التي تحتوي `target_settlement_date` في الفترة.
  - قائمة أو جدول: عنوان المهمة، مسند إلى، منفذ، تاريخ التسوية المستهدف، تاريخ التنفيذ، حالة التحقق (إن وُجدت في `task_executions`).

---

### القسم 9: سجل التدقيق (اختياري)

- **مصدر البيانات:** `audit_log`.
- **المحتوى:** آخر N حدث (تسجيل دخول، تعديل، حذف، إلخ) مع تاريخ، مستخدم، إجراء، كيان.

---

## مصدر الأفكار: لوحة TV

يُستفاد من منطق `tvDashboardController.js` في:

- **نظرة عامة اليوم/الشهر:** overview، إحصائيات الموظفين، الحضور، المهام المجدولة والإضافية.
- **إحصائيات الموظف (يومي/شهري):** dailyAll، monthlyAll، scheduledByEmp، adHocByEmp، attendanceToday، attendanceMonthly، categoriesByEmp، bestDay.
- **إنجازات القسم الشهرية:** departmentMonthlySlide (مجموع مهام، توزيع فئات، أيام حضور).
- **الفئات:** categoriesSlide، monthlyScheduledByCategorySlide.
- **التغطية:** coverageSlide.
- **RTGS:** استيرادات، حركات، ملخصات (من import_logs + تجميع rtgs).
- **CT:** ct_records (قائمة + مطابقة/غير مطابقة).
- **التسويات الحكومية:** governmentSettlementsSlide (مهام)، governmentSettlementCardsSlide (كروت من gov_settlement_summaries/details)، settlementsMatchingOverviewSlide (KPI + حسب المصرف).
- **المهام الإضافية الشهرية حسب الموظف:** monthlyAdditionalByEmployeeSlide.

كل ما سبق يُعاد استخدامه أو تكييفه في API التقارير الشاملة وعرض الصفحة.

---

## تصميم API المقترح

### نقطة واحدة للتقارير الشاملة (مع فلتر فترة)

```
GET /api/reports/comprehensive
  ?period=day|week|month|custom
  &date=YYYY-MM-DD          (لـ day)
  &month=1-12&year=YYYY     (لـ month)
  &dateFrom=YYYY-MM-DD&dateTo=YYYY-MM-DD  (لـ custom/week)
```

**الاستجابة:** كائن JSON يحتوي أقساماً (sections) بحيث:

- **summary:** KPI عامة (موظفون، حضور، مهام، **تسويات من gov_settlement_***، CT، مهام تسوية حكومية، مستحقات تجار).
- **department:** إحصائيات القسم، توزيع الفئات، جدول موظفين موجز.
- **employees:** مصفوفة تفاصيل كل موظف (حضور، مهام، تغطية، فئات، أفضل يوم).
- **tasks:** ملخص مجدولة/إضافية، متأخرة، تغطية.
- **settlements:** إحصائيات من gov_settlement_summaries (حركات، مبالغ، تسوية)، قائمة استيراد (سياق).
- **govSettlements:** ملخصات (summaries) + توزيع حسب المصرف (detailsByBank من gov_settlement_details).
- **ctMatching:** إحصائيات CT وقائمة سجلات.
- **merchants:** عدد التجار، إحصائيات صرف المستحقات.
- **categories:** توزيع المهام حسب الفئة.
- **govTasks:** مهام التسوية الحكومية (target_settlement_date).
- **audit:** آخر أحداث (اختياري).

لا يُستخدم جدول `rtgs`. للجداول الكبيرة (`gov_settlement_details`): إرجاع إحصاءات مجمّعة (COUNT, SUM) فقط ضمن النطاق المحدد.

---

## واجهة المستخدم (صفحة واحدة عملاقة)

1. **أعلى الصفحة:** عنوان "التقارير الشاملة"، فلتر الفترة (يوم / أسبوع / شهر / مخصص)، زر تحديث، أزرار تصدير (Excel / PDF) إن وُجدت.
2. **شريط KPI:** بطاقات أو أرقام سريعة للملخص العام (كما في المستوى 0).
3. **أقسام قابلة للطي/توسيع (Accordion أو Tabs):**
   - نظرة عامة القسم والموظفون
   - تفصيل كل موظف (قائمة موظفين، عند النقر على موظف يُعرض تفصيله)
   - المهام والتنفيذ (مجدولة، إضافية، متأخرة، تغطية)
   - التسويات (من تفاصيل وملخصات التسويات الحكومية فقط — بدون rtgs)
   - مطابقة CT
   - التجار وصرف المستحقات
   - الفئات
   - مهام التسوية الحكومية
   - سجل التدقيق (اختياري)
4. **تصدير:** تصدير التقرير الحالي (نطاق الفترة + الأقسام المختارة) إلى Excel أو PDF حسب الصلاحيات.

---

## ترتيب التنفيذ المقترح

| المرحلة | المهمة | الملفات |
|---------|--------|---------|
| 1 | وثيقة الخطة (هذه الوثيقة) | docs/COMPREHENSIVE_REPORTS_PLAN.md |
| 2 | Backend: إضافة comprehensive report في reportsController + route | server/controllers/reportsController.js, server/routes/reports.js |
| 3 | Frontend: صفحة جديدة reports-comprehensive أو استبدال reports-v2 بهيكل أقسام + فلتر فترة | client/src/pages/reports-comprehensive.tsx (أو إعادة بناء reports-v2) |
| 4 | ربط كل قسم من الاستجابة بمكوّن عرض (جداول، بطاقات، قوائم) | نفس الملف + مكونات فرعية إن لزم |
| 5 | تصدير Excel/PDF للتقارير الشاملة (اختياري لاحق) | reportsController export |

---

## ملخص الضمان

- **كل الجداول المستخدمة:** users, attendance, daily_tasks, ad_hoc_tasks, task_executions, task_templates, categories, schedules, attachments, import_logs (سياق), gov_settlement_summaries, gov_settlement_details, ct_records, merchants, merchant_disbursements, audit_log. **لا يُستخدم جدول rtgs.**
- **لا يترك شيئاً:** مهام (مجدولة + إضافية)، تسويات، مطابقات، فئات، حضور، موظفون، تغطية، تجار، مستحقات، تدقيق.
- **مدير مفوض:** نظرة عامة + تفصيل كل موظف في مكان واحد.

بعد الموافقة على الخطة ننتقل لمرحلة التنفيذ (Backend ثم Frontend).

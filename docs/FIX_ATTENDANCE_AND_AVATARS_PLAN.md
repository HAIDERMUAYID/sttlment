# خطة معالجة: الحضور لا يُحفظ بشكل صحيح + اختفاء الصور الشخصية

## الملخص

| المشكلة | السبب المحتمل | الحل المقترح |
|---------|----------------|----------------|
| الحضور لا يُحفظ بشكل صحيح | توقيت السيرفر، عدم معالجة أخطاء INSERT، أو عدم استخدام Transaction | التحقق من التوقيت، إضافة Transaction ومعالجة أخطاء وتسجيل (Logging) |
| الصور تظهر ثم تختفي بعد فترة | تخزين الملفات على قرص مؤقت (Ephemeral) في الاستضافة (مثلاً Render) | تخزين دائم: قرص مستمر (Disk) أو S3 / تخزين سحابي |

---

## 1. مشكلة الحضور (Attendance)

### 1.1 آلية الحفظ الحالية

- **أين يُسجَّل الحضور؟** في `server/controllers/authController.js` عند تسجيل الدخول فقط.
- **الاستعلام:**
  ```sql
  INSERT INTO attendance (user_id, date, first_login_at)
  VALUES ($1, $2, $3)
  ON CONFLICT (user_id, date) DO NOTHING
  ```
- **المصدر:**
  - `date` = `getTodayBaghdad()` → تاريخ اليوم بتوقيت بغداد (نص `YYYY-MM-DD`).
  - `first_login_at` = `getNowBaghdad().toDate()` → وقت الدخول الحالي بتوقيت بغداد يُحوَّل إلى `Date`.

### 1.2 نقاط قد تسبب عدم حفظ الحضور بشكل صحيح

| # | الاحتمال | الوصف | كيف نتحقق / نعالج |
|---|----------|--------|-------------------|
| 1 | **عدم استخدام Transaction** | إذا فشل شيء بعد `INSERT` (مثلاً إنشاء التوكن أو `auditLog`) يرجع 500 للمستخدم، لكن الحضور قد يكون قد دخل. والعكس: إذا فشل الـ INSERT ولم نتعامل مع الخطأ، المستخدم يحصل على 500 ولا يُسجَّل حضور. | لف عملية تسجيل الدخول (بما فيها تسجيل الحضور) داخل Transaction، والـ COMMIT بعد نجاح كل الخطوات. في حال فشل أي خطوة نعمل ROLLBACK. |
| 2 | **توقيت السيرفر خاطئ** | `getTodayBaghdad()` يعتمد على `moment().tz('Asia/Baghdad')` الذي يعتمد على وقت نظام السيرفر. إذا كان وقت السيرفر غير مضبوط، قد يُسجَّل التاريخ أو الوقت خطأ. | التأكد من ضبط `TZ` أو وقت السيرفر (مثلاً `Asia/Baghdad`). إضافة سجلات (logs) عند تسجيل الحضور: `date` و `first_login_at` للتحقق لاحقاً. |
| 3 | **خطأ في الـ INSERT غير معالج** | أي خطأ من قاعدة البيانات (اتصال، قيد، نوع بيانات) يرمي استثناء ولا يُعاد للمستخدم رسالة واضحة، وقد لا يُسجَّل الحضور. | استخدام try/catch حول استعلام الحضور. في حال فشل الحضور: تسجيل الخطأ (logging) وعدم إفشال تسجيل الدخول بالكامل (أو إرجاع رسالة مناسبة حسب السياسة). |
| 4 | **تعارض التوقيت بين الواجهة والسيرفر** | واجهة الحضور (`attendance-v2`) تستخدم `moment()` بدون timezone (توقيت المتصفح). لو المستخدم في timezone مختلف عن بغداد، قد يرى اليوم "الخاطئ" أو يظن أن الحضور غير محفوظ. | توحيد التوقيت في الواجهة على بغداد عند عرض تقويم الحضور (مثلاً `moment().tz('Asia/Baghdad')`) حتى يتطابق مع ما يرجعه السيرفر. |
| 5 | **قيد UNIQUE أو نوع البيانات** | جدول `attendance` فيه `UNIQUE(user_id, date)`. لو تم إرسال `date` بصيغة أو نوع غير متوقع، قد يحدث خطأ أو سلوك غير متوقع. | التأكد أن `getTodayBaghdad()` يعيد دائماً `YYYY-MM-DD` ونوع العمود `DATE` يقبله. إضافة تحقق بسيط قبل الـ INSERT (مثلاً التحقق من صحة النص كتاريخ). |

### 1.3 خطوات التنفيذ المقترحة (الحضور)

1. **إضافة Transaction لتسجيل الدخول**
   - بدء Transaction قبل: التحقق من المستخدم، تسجيل الحضور، إنشاء التوكن، `auditLog`.
   - تنفيذ كل العمليات ثم `COMMIT`.
   - عند أي فشل: `ROLLBACK` وإرجاع رسالة خطأ مناسبة.

2. **معالجة أخطاء تسجيل الحضور بشكل صريح**
   - تنفيذ `INSERT` الحضور داخل `try/catch`.
   - في حال الفشل: تسجيل الخطأ (مثلاً `console.error` أو logger)، واتخاذ قرار إما:
     - إما المتابعة دون إفشال تسجيل الدخول (مع تسجيل أن الحضور لم يُسجَّل)، أو
     - إرجاع رسالة مثل "تم تسجيل الدخول لكن لم يتم تسجيل الحضور، يرجى التواصل مع الدعم".

3. **إضافة Logging للتحقق**
   - قبل/بعد الـ INSERT: طباعة أو تسجيل `userId`, `date`, `first_login_at` (في بيئة التطوير أو عبر مستوى log مناسب) للتحقق من القيم الفعلية.

4. **توحيد التوقيت في واجهة الحضور**
   - في `client/src/pages/attendance-v2.tsx` (وأي صفحة تعرض تقويم الحضور): استخدام توقيت بغداد عند حساب "اليوم" وعرض التواريخ، مثلاً `moment().tz('Asia/Baghdad')`، حتى يتطابق العرض مع ما يُحفظ في السيرفر.

5. **التحقق من البيئة**
   - التأكد من وجود `TIMEZONE=Asia/Baghdad` (أو ما يعادله) في بيئة التشغيل (مثل `render.yaml` أو متغيرات البيئة)، وأن وقت السيرفر مضبوط.

---

## 2. مشكلة الصور الشخصية (الاختفاء بعد فترة)

### 2.1 آلية التخزين الحالية

- **الرفع:** `server/controllers/usersController.js` → `uploadAvatar`.
- **المسار:** الملفات تُحفظ في `process.cwd()/uploads/avatars/` (مجلد محلي على السيرفر).
- **قاعدة البيانات:** يُحفظ في `users.avatar_url` مسار مثل: `/api/uploads/avatars/{filename}`.
- **العرض:** السيرفر يخدم الملفات عبر `express.static('uploads')` في `server/index.js`.
- **ملاحظة:** مجلد `uploads/` موجود في `.gitignore` ولا يُرفع مع الكود.

### 2.2 سبب اختفاء الصور بعد فترة

- في منصات استضافة مثل **Render** و **Heroku**، نظام الملفات **مؤقت (Ephemeral)**:
  - عند كل إعادة تشغيل (Restart) أو إعادة نشر (Redeploy) يُمسح محتوى القرص.
  - مجلد `uploads/avatars/` يُفقد، بينما قاعدة البيانات تبقى فيها قيم `avatar_url` كما هي.
- النتيجة: الطلب إلى `/api/uploads/avatars/xxx` يرجع 404 أو صورة مكسورة، فيبدو للمستخدم أن "الصورة اختفت".

### 2.3 حلول مقترحة (الصور الشخصية)

| # | الحل | الوصف | أولوية |
|---|------|--------|--------|
| 1 | **استخدام قرص مستمر (Persistent Disk)** | إنشاء "Disk" في Render وربطه بالتطبيق، وجعل مسار رفع الصور على هذا القرص. الملفات تبقى بعد إعادة النشر. | مناسبة إذا بقي التطبيق على Render وبدون تغيير كبير في الكود. |
| 2 | **تخزين سحابي (S3 أو ما شابه)** | رفع الملفات إلى S3 (أو GCS أو مشابه)، وحفظ في DB الرابط العام (أو الموقّت) للصورة. لا يعتمد على قرص السيرفر. | الأفضل على المدى الطويل وقابل للتوسع. |
| 3 | **معالجة 404 في الواجهة** | عند فشل تحميل الصورة (onError)، إظهار صورة افتراضية أو أحرف الاسم بدلاً من أيقونة مكسورة. | يُنفَّذ في كل الحالات لتحسين التجربة حتى بعد نقل التخزين. |

### 2.4 خطوات تنفيذ مقترحة (الصور)

1. **قصير المدى (تحسين التجربة فوراً)**
   - في كل الأماكن التي تعرض `avatar_url` (مثل `users-v2.tsx`, `change-password-v2.tsx`, `tv-dashboard-v2.tsx`):
     - استخدام `onError` على `<img>` أو المكون الذي يعرض الصورة.
     - عند حدوث خطأ (404 أو فشل التحميل): إخفاء الصورة أو استبدالها بـ placeholder (مثلاً أول حرف من الاسم أو أيقونة مستخدم).
   - التأكد أن الـ API لا يرجع 500 عند غياب الملف؛ إن أمكن، التحقق من وجود الملف قبل الإشارة إليه أو تقديم رابط بديل.

2. **متوسط المدى (استقرار التخزين)**
   - **خيار أ (مُنفَّذ):** تم دعم المتغير **`UPLOAD_PATH`** في السيرفر. عند تعيينه (مثلاً لمسار قرص مستمر في Render)، تُحفظ الصور هناك وتُخدم منه. إعداد Render: إضافة Disk ثم تعيين `UPLOAD_PATH=/mnt/data/uploads` (أو المسار الذي يربط Render للقرص).
   - **خيار ب:** دمج **S3** (أو خدمة مشابهة):
     - إضافة حزمة مثل `@aws-sdk/client-s3` و `multer-s3` (أو رفع يدوي بعد multer memory).
     - حفظ الملف في S3 ثم تخزين الرابط العام (أو الموقّت) في `users.avatar_url`.
     - تحديث الواجهة لاستخدام الرابط الجديد (قد لا تحتاج لتعديل كبير إذا كان الحقل يخزن URL كامل).

3. **التحقق بعد التعديل**
   - رفع صورة شخصية ثم إعادة تشغيل أو إعادة نشر التطبيق والتحقق أن الصورة لا تزال تظهر (مع Disk أو S3).
   - التأكد أن حذف الصورة من الإعدادات يزيلها من التخزين ويُحدّث `avatar_url` في DB.

---

## 3. ترتيب التنفيذ المقترح

| المرحلة | المهمة | الملفات المتأثرة تقريباً |
|---------|--------|---------------------------|
| 1 | معالجة أخطاء وتسجيل (logging) للحضور + Transaction لتسجيل الدخول | `server/controllers/authController.js` |
| 2 | توحيد توقيت بغداد في واجهة الحضور | `client/src/pages/attendance-v2.tsx` |
| 3 | معالجة onError للصور (placeholder عند فشل التحميل) | مكونات العرض التي تستخدم `avatar_url` (مثل `users-v2`, `change-password-v2`, `tv-dashboard-v2`, إلخ) |
| 4 | دعم مسار تخزين دائم (UPLOAD_PATH) + معالجة onError للصور | `server/utils/uploadPath.js`, `server/middleware/upload.js`, `server/index.js`, `server/controllers/usersController.js`، وصفحات TV (عرض placeholder عند فشل تحميل الصورة) |
| 5 | التحقق النهائي: اختبار الحضور + رفع صورة ثم إعادة نشر واختبار العرض | — |

---

## 4. ملخص التحقق النهائي

- **الحضور:** تسجيل دخول في أوقات مختلفة (قرب منتصف الليل بغداد إن أمكن)، والتحقق من وجود سجل في `attendance` للتاريخ المتوقع، ومن تطابق التواريخ في واجهة الحضور.
- **الصور:** رفع صورة → إعادة نشر التطبيق → التأكد أن الصورة لا تزال تظهر، وأن وضع placeholder يعمل عند 404.

بعد تنفيذ هذه الخطوات يمكن اعتبار مشكلتي "الحضور لا يُحفظ" و "اختفاء الصور بعد فترة" مُعالَجَتين وفق البيئة والسياسة المختارة (Transaction + توقيت + تخزين دائم للصور).

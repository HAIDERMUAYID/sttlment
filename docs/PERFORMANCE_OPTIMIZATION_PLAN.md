# خطة تحسين الأداء — تنفيذ محكم

## المبادئ
- **لا تغيير** في بنية الجداول أو الـ APIs أو منطق النظام.
- **تحسين فقط**: فهارس، ضبط استعلامات، اتصالات، تخزين مؤقت، ضغط، واجهة.
- تنفيذ على مراحل مع إمكانية قياس الأثر.

---

## المرحلة 1: قاعدة البيانات (أولوية عالية)

### 1.1 فهارس إضافية (Migration 021)
- **الهدف:** تسريع الـ JOIN والفلترة في التقارير والمهام ولوحة TV.
- **الإجراء:** إضافة فهارس فقط (لا تغيير جداول):
  - `task_executions(daily_task_id)` — للـ JOIN مع daily_tasks واستعلامات LATERAL.
  - `task_executions(ad_hoc_task_id)` — للـ JOIN مع ad_hoc_tasks.
  - `task_executions(done_by_user_id, result_status)` — لعدّ المكتمل/المتأخر حسب المستخدم.
  - `daily_tasks(template_id)` — للـ JOIN مع task_templates في التقارير.
  - `daily_tasks(task_date, assigned_to_user_id)` — مركّب للفلترة الشائعة.
  - `gov_settlement_summaries(sttl_date, bank_display_name)` — لاستعلامات التجميع حسب المصرف.
- **الملف:** `server/migrations/021_performance_indexes.sql`.

### 1.2 إدارة اتصالات قاعدة البيانات
- **الهدف:** تقليل انقطاع الاتصال و«Service unavailable».
- **الإجراء:** في `server/config/database.js`:
  - توثيق/ضبط `max` (مثلاً 10–20 حسب الحمل) عبر `POOL_MAX`.
  - `idleTimeoutMillis` و`connectionTimeoutMillis` مناسبة (مثلاً 30s و10s).
  - عدم إنهاء العملية فوراً عند خطأ idle إن أمكن (معالجة الخطأ دون `process.exit` إن كان مقبولاً؛ أو ترك الإعداد الحالي إن كان متعمداً للأمان).

---

## المرحلة 2: السيرفر (أولوية متوسطة–عالية)

### 2.1 ضغط الردود (Gzip)
- **الهدف:** تقليل حجم نقل الـ JSON ووقت التحميل في المتصفح.
- **الإجراء:** إضافة middleware ضغط للردود (مثلاً حزمة `compression`) وتفعيله للـ API. لا تغيير في محتوى الردود.

### 2.2 تخزين مؤقت خفيف للتقارير
- **الهدف:** تسريع الطلبات المكررة لنفس الفترة/الفلتر دون المساس بدقة البيانات.
- **الإجراء:**
  - تخزين مؤقت في الذاكرة لنتائج نقطة واحدة أو أكثر (مثلاً `/reports/full` أو `/reports/daily`) مع مفتاح يعتمد على `period, dateFrom, dateTo`.
  - TTL قصير (مثلاً 1–2 دقيقة) حتى لا تبقى البيانات قديمة.
  - بدون تغيير في توقيع الـ API أو منطق الحساب.

---

## المرحلة 3: الواجهة الأمامية (أولوية متوسطة)

### 3.1 تحميل تدريجي للبيانات
- **الهدف:** ظهور هيكل الصفحة سريعاً ثم جلب البيانات (شعور أقرب لـ Power BI).
- **الإجراء:** التأكد من أن الصفحات الثقيلة (تقارير، قوائم) تعرض الهيكل ومؤشر التحميل فوراً وتستدعي الـ API دون حجب الـ render (الوضع الحالي مع React Query غالباً كافٍ؛ مراجعة أي استدعاءات تُنفَّذ قبل أول paint).

### 3.2 virtualization للجداول الطويلة
- **الهدف:** تقليل عناصر DOM والـ re-renders عند عرض آلاف الصفوف.
- **الإجراء:** في الصفحات التي تعرض قوائم طويلة (مهام، تقارير تفصيلية)، استخدام virtualization (مثلاً `react-window` أو مكون جدول افتراضي) دون تغيير مصدر البيانات أو الـ API.

---

## ترتيب التنفيذ المقترح

| # | المهمة | الملف/المكان | الحالة |
|---|--------|--------------|--------|
| 1 | فهارس الأداء | `021_performance_indexes.sql` | تم |
| 2 | ضبط Pool (توثيق + env) | `server/config/database.js` | تم |
| 3 | ضغط Gzip | `server/index.js` + حزمة `compression` | تم |
| 4 | تخزين مؤقت خفيف للتقارير | `reportsController.js` — `/full`، `/daily`، `/comprehensive` TTL 90 ثانية | تم |
| 5 | تحميل تدريجي + واجهة | `reports-v2.tsx` — Skeleton، staleTime 90 ثانية | تم |
| 6 | Virtualization للجداول الطويلة | `reports-v2.tsx` — جدول «المهام حسب القالب والفئة» بـ `@tanstack/react-virtual` | تم |

---

## الحالة المثالية (ما تم إنجازه)

- **قاعدة البيانات:** فهارس 021 مطبّقة؛ توثيق Pool و`POOL_MAX` في `.env`.
- **السيرفر:** Gzip مفعّل؛ تخزين مؤقت في الذاكرة لـ `/reports/full`، `/reports/daily`، `/reports/comprehensive` (TTL 90 ثانية).
- **الواجهة:** تقرير `/full` يستخدم `staleTime: 90_000`؛ صفحة التقارير تعرض Skeleton أثناء التحميل؛ جدول القوالب والفئة افتراضي (virtualized) لتحسين الأداء مع آلاف الصفوف.
- **بدون تغيير:** بنية الجداول، الـ APIs، منطق النظام — تحسين أداء فقط.

---

## تحسينات صفحة RTGS (تأخير أقل)

معظم التأخير كان في صفحة RTGS؛ تم تطبيق التالي:

| الإجراء | الملف/المكان |
|---------|--------------|
| فهارس للقائمة والترتيب | `022_rtgs_performance_indexes.sql`: `rtgs(sttl_date DESC, id DESC)`، `message_type`، `terminal_type` |
| تخزين مؤقت خيارات الفلتر | `rtgsController.js`: `getRtgsFilterOptions` — مفتاح حسب نطاق التاريخ، TTL 60 ثانية |
| تخزين مؤقت قائمة الحركات | `rtgsController.js`: `getRtgs` — مفتاح حسب كل معاملات الطلب، TTL 30 ثانية |
| خيارات الفلتر في الواجهة | `RTGS.tsx`: `useQuery` مع `staleTime: 60_000` — عدم إعادة جلب الخيارات في كل فتح للصفحة |

بعد التطبيق: تشغيل `npm run migrate` لتفعيل فهارس 022 إن لم تُنفَّذ بعد.

---

## قياس الأثر (اختياري)
- قبل/بعد كل مرحلة: قياس زمن استجابة نقاط ثقيلة (مثلاً `GET /api/reports/full`, `GET /api/tasks/daily`) وحجم الرد إن أمكن.
- استخدام `/api/health` لمراقبة `dbLatencyMs` واستقرار الاتصال.
